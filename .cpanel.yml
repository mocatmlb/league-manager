---
deployment:
  tasks:
    # Create necessary directories
    - mkdir -p $HOME/public_html/includes
    - mkdir -p $HOME/public_html/logs
    - mkdir -p $HOME/public_html/uploads
    - mkdir -p $HOME/public_html/backups
    
    # Copy includes directory to web root
    - cp -R includes/* $HOME/public_html/includes/
    
    # Copy public files
    - cp -R public/* $HOME/public_html/
    
    # Copy configuration files
    - cp -f includes/config.prod.php $HOME/public_html/includes/config.php
    
    # Set proper permissions
    - chmod 644 $HOME/public_html/includes/*.php
    - chmod 755 $HOME/public_html/includes
    - chmod 755 $HOME/public_html/logs
    - chmod 755 $HOME/public_html/uploads
    - chmod 755 $HOME/public_html/backups
    
    # Make directories writable by web server
    - chown -R $USER:nobody $HOME/public_html/logs
    - chown -R $USER:nobody $HOME/public_html/uploads
    - chown -R $USER:nobody $HOME/public_html/backups
    
    # Clear any existing caches
    - rm -rf $HOME/public_html/logs/*
    - rm -rf $HOME/tmp/*
    
    # Create .htaccess to protect includes directory
    - echo "Order deny,allow" > $HOME/public_html/includes/.htaccess
    - echo "Deny from all" >> $HOME/public_html/includes/.htaccess
    
    # Create empty log file with correct permissions
    - touch $HOME/public_html/logs/app.log
    - chmod 664 $HOME/public_html/logs/app.log
    - chown $USER:nobody $HOME/public_html/logs/app.log